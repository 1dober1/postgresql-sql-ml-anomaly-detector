# PostgreSQL SQL Anomaly Detector ‚Äî Data Pipeline (pg_stat_statements ‚Üí Features)

–≠—Ç–æ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–Ω–≤–µ–π–µ—Ä –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è ML-–¥–µ—Ç–µ–∫—Ü–∏–∏ –∞–Ω–æ–º–∞–ª–∏–π –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ PostgreSQL.  
–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ `pg_stat_statements`, –∫–æ—Ç–æ—Ä–æ–µ —Ö—Ä–∞–Ω–∏—Ç **–Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–µ** —Å—á—ë—Ç—á–∏–∫–∏ –ø–æ –∑–∞–ø—Ä–æ—Å–∞–º (queryid).

## TL;DR (—á—Ç–æ –¥–µ–ª–∞–µ—Ç –ø–∞–π–ø–ª–∞–π–Ω)
–ú—ã –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–µ —Å—á—ë—Ç—á–∏–∫–∏ –∏–∑ `pg_stat_statements` –≤:
1) **—Å–Ω–∞–ø—à–æ—Ç—ã** (raw snapshots) ‚Äî ‚Äú—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏‚Äù —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –Ω–∞ –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏  
2) **–¥–µ–ª—å—Ç—ã** (deltas) ‚Äî ‚Äú—á—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –∑–∞ –æ–∫–Ω–æ‚Äù –º–µ–∂–¥—É –¥–≤—É–º—è —Å–Ω–∞–ø—à–æ—Ç–∞–º–∏  
3) **–æ–∫–æ–Ω–Ω—ã–µ —Ñ–∏—á–∏** (features) ‚Äî –Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –¥–ª—è ML  
4) **–ª–µ–∫—Å–∏—á–µ—Å–∫–∏–µ —Ñ–∏—á–∏** (lex features) ‚Äî —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –ø–æ —Ç–µ–∫—Å—Ç—É –∑–∞–ø—Ä–æ—Å–∞  
5) **–µ–¥–∏–Ω—ã–π –¥–∞—Ç–∞—Å–µ—Ç** –¥–ª—è ML ‚Äî —á–µ—Ä–µ–∑ view `monitoring.features_with_lex`

---

## –°—Ö–µ–º–∞ –ë–î
–í—Å–µ —Å–ª—É–∂–µ–±–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ —Å—Ö–µ–º–µ `monitoring`:

- `monitoring.pgss_snapshots_raw` ‚Äî —Å—ã—Ä—ã–µ —Å–Ω–∞–ø—à–æ—Ç—ã `pg_stat_statements`
- `monitoring.pgss_deltas` ‚Äî –¥–µ–ª—å—Ç—ã —Å—á—ë—Ç—á–∏–∫–æ–≤ –º–µ–∂–¥—É –¥–≤—É–º—è —Å–Ω–∞–ø—à–æ—Ç–∞–º–∏ (–æ–¥–Ω–æ ‚Äú–æ–∫–Ω–æ‚Äù)
- `monitoring.features_windows` ‚Äî –ø—Ä–∏–∑–Ω–∞–∫–∏ –ø–æ –æ–∫–Ω–∞–º (–¥–ª—è ML)
- `monitoring.query_lex_features` ‚Äî –ª–µ–∫—Å–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ (—Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ø–æ queryid)
- `monitoring.features_with_lex` (VIEW) ‚Äî –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –æ–∫–æ–Ω–Ω—ã—Ö + –ª–µ–∫—Å–∏—á–µ—Å–∫–∏—Ö —Ñ–∏—á

---

## –°–∫—Ä–∏–ø—Ç—ã

### 1) `collector.py` ‚Äî —Å–±–æ—Ä —Å–Ω–∞–ø—à–æ—Ç–æ–≤ –∏–∑ `pg_stat_statements`
**–ó–∞–¥–∞—á–∞:** –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ (cron/—Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫) —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–æ–≤.

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –æ–¥–∏–Ω —Ä–∞–∑ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç `snapshot_ts` (timestamp –∑–∞–ø—É—Å–∫–∞)
- —á–∏—Ç–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–∑ `pg_stat_statements`
- –≤—Å—Ç–∞–≤–ª—è–µ—Ç —Å—Ç—Ä–æ–∫–∏ –≤ `monitoring.pgss_snapshots_raw`

**–ü–æ—á–µ–º—É —ç—Ç–æ –Ω—É–∂–Ω–æ:**
`pg_stat_statements` —Ö—Ä–∞–Ω–∏—Ç –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–µ —Å—á—ë—Ç—á–∏–∫–∏ (calls/total_exec_time/blocks/wal).  
–ß—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å ‚Äú–Ω–∞–≥—Ä—É–∑–∫—É –∑–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª‚Äù, –Ω–∞–¥–æ –≤–∑—è—Ç—å —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É –¥–≤—É–º—è —Å–Ω–∞–ø—à–æ—Ç–∞–º–∏.

**–í—ã—Ö–æ–¥:** `monitoring.pgss_snapshots_raw`

---

### 2) `build_deltas.py` ‚Äî —Ä–∞—Å—á—ë—Ç –¥–µ–ª—å—Ç –º–µ–∂–¥—É –¥–≤—É–º—è —Å–Ω–∞–ø—à–æ—Ç–∞–º–∏
**–ó–∞–¥–∞—á–∞:** –∏–∑ –¥–≤—É—Ö –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–Ω–∞–ø—à–æ—Ç–æ–≤ –ø–æ–ª—É—á–∏—Ç—å ‚Äú—á—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ –∑–∞ –æ–∫–Ω–æ‚Äù.

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –Ω–∞—Ö–æ–¥–∏—Ç **–¥–≤–∞ —Ä–∞–∑–Ω—ã—Ö** –ø–æ—Å–ª–µ–¥–Ω–∏—Ö `snapshot_ts` –≤ `monitoring.pgss_snapshots_raw`
- —Å–æ–µ–¥–∏–Ω—è–µ—Ç —Å—Ç—Ä–æ–∫–∏ –ø–æ `(dbid, userid, queryid)`
- —Å—á–∏—Ç–∞–µ—Ç –¥–µ–ª—å—Ç—ã:
  - `calls_delta`
  - `total_exec_time_delta`
  - `rows_delta`
  - `shared_blks_*_delta`
  - `temp_blks_*_delta`
  - `wal_bytes_delta`
- —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ `monitoring.pgss_deltas` —Å –ø–æ–ª—è–º–∏:
  - `window_start` = –≤—Ä–µ–º—è –ø–µ—Ä–≤–æ–≥–æ —Å–Ω–∞–ø—à–æ—Ç–∞
  - `window_end` = –≤—Ä–µ–º—è –≤—Ç–æ—Ä–æ–≥–æ —Å–Ω–∞–ø—à–æ—Ç–∞

**–í–∞–∂–Ω–æ:**
- –≤ `pgss_deltas` –æ–±—ã—á–Ω–æ –ø–æ–ø–∞–¥–∞–µ—Ç **–º–∞–ª–æ —Å—Ç—Ä–æ–∫**, –ø–æ—Ç–æ–º—É —á—Ç–æ –º—ã —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ –∑–∞–ø—Ä–æ—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–∞–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω—è–ª–∏—Å—å –≤ –æ–∫–Ω–µ (`calls_delta > 0` –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä).
- –µ—Å–ª–∏ —Å–Ω–∞–ø—à–æ—Ç–æ–≤ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚Äî —Å–∫—Ä–∏–ø—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–∏—à–µ—Ç: `Not enough snapshots to compute deltas.`

**–í—ã—Ö–æ–¥:** `monitoring.pgss_deltas`

---

### 3) `build_features.py` ‚Äî —Ä–∞—Å—á—ë—Ç –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –æ–∫–Ω–∞ (–¥–ª—è ML)
**–ó–∞–¥–∞—á–∞:** –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –¥–µ–ª—å—Ç—ã –≤ –Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∏—á–∏, —É–¥–æ–±–Ω—ã–µ –¥–ª—è –º–æ–¥–µ–ª–∏.

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –±–µ—Ä—ë—Ç –Ω–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏–∑ `monitoring.pgss_deltas`
- —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç `window_len_sec = window_end - window_start` –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
- —Å—Ç—Ä–æ–∏—Ç –ø—Ä–∏–∑–Ω–∞–∫–∏:
  - –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏: `calls_per_sec`, `rows_per_sec`, `exec_ms_per_sec`, `wal_bytes_per_sec` –∏ —Ç.–ø.
  - –Ω–æ—Ä–º–∏—Ä–æ–≤–∫–∏: `exec_time_per_call_ms`, `rows_per_call`, `wal_bytes_per_call` –∏ —Ç.–ø.
  - –¥–æ–ª–∏/–æ—Ç–Ω–æ—à–µ–Ω–∏—è: `cache_miss_ratio`, `temp_share` –∏ —Ç.–ø. (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ)
- –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ `monitoring.features_windows`

**–ü–æ—á–µ–º—É —Ç–∞–∫:**
–ê–±—Å–æ–ª—é—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, `wal_bytes_delta`) —Å–∏–ª—å–Ω–æ –∑–∞–≤–∏—Å—è—Ç –æ—Ç –¥–ª–∏–Ω—ã –æ–∫–Ω–∞.  
–ù–æ—Ä–º–∏—Ä–æ–≤–∫–∏/–∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–∑–≤–æ–ª—è—é—Ç —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å –æ–∫–Ω–∞ —Ä–∞–∑–Ω–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –ª—É—á—à–µ –ø–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è ML.

**–í—ã—Ö–æ–¥:** `monitoring.features_windows`

---

### 4) `build_lex_features.py` ‚Äî –ª–µ–∫—Å–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –ø–æ —Ç–µ–∫—Å—Ç—É –∑–∞–ø—Ä–æ—Å–∞
**–ó–∞–¥–∞—á–∞:** –ø–æ—Å—Ç—Ä–æ–∏—Ç—å ‚Äú—Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫‚Äù –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –ø–æ SQL-—Ç–µ–∫—Å—Ç—É (–Ω–µ –ø–æ –æ–∫–Ω—É).

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –±–µ—Ä—ë—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ `query_text` –∏–∑ `monitoring.pgss_snapshots_raw` –ø–æ –∫–∞–∂–¥–æ–º—É `(dbid, userid, queryid)`
- –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç —Ç–µ–∫—Å—Ç (—É–¥–∞–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –∫ lower, –∑–∞–º–µ–Ω–∞ –ª–∏—Ç–µ—Ä–∞–ª–æ–≤/—á–∏—Å–µ–ª –∏ —Ç.–ø.)
- —Å—á–∏—Ç–∞–µ—Ç –ª–µ–∫—Å–∏—á–µ—Å–∫–∏–µ/—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä:
  - –¥–ª–∏–Ω–∞ –∑–∞–ø—Ä–æ—Å–∞, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤
  - `JOIN/WHERE/GROUP BY/ORDER BY/HAVING/UNION`
  - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–∑–∞–ø—Ä–æ—Å–æ–≤, CTE
  - —Ñ–ª–∞–≥–∏: –µ—Å—Ç—å –ª–∏ DML/DDL/TRANSACTION
  - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ—É–Ω–∫—Ü–∏–π, CASE
- –ø–∏—à–µ—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç `monitoring.query_lex_features` —á–µ—Ä–µ–∑ UPSERT
- –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –Ω–µ –º–µ–Ω—è–ª—Å—è ‚Äî –ø–∏—à–µ—Ç: `Lex features are up-to-date (nothing to insert/update).`

**–í–∞–∂–Ω–æ:**
–õ–µ–∫—Å–∏–∫–∞ ‚Äî **—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è** –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ queryid (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ä–µ–¥–∫–æ), –ø–æ—ç—Ç–æ–º—É —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å —Ä–µ–∂–µ, —á–µ–º —Å–±–æ—Ä –æ–∫–æ–Ω.

**–í—ã—Ö–æ–¥:** `monitoring.query_lex_features`

---

## View –¥–ª—è ML: `monitoring.features_with_lex`
**–ß—Ç–æ —ç—Ç–æ:** –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –æ–∫–æ–Ω–Ω—ã—Ö –∏ –ª–µ–∫—Å–∏—á–µ—Å–∫–∏—Ö —Ñ–∏—á.

–õ–æ–≥–∏–∫–∞:
- `features_windows` ‚Äî ‚Äú—á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ –∑–∞ –æ–∫–Ω–æ‚Äù (—Ä–µ—Å—É—Ä—Å—ã/–≤—Ä–µ–º—è/–∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏)
- `query_lex_features` ‚Äî ‚Äú–∫–∞–∫–æ–π —ç—Ç–æ –∑–∞–ø—Ä–æ—Å –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ‚Äù (–ª–µ–∫—Å–∏–∫–∞/–∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞/—Å–ª–æ–∂–Ω–æ—Å—Ç—å)

View –¥–µ–ª–∞–µ—Ç `LEFT JOIN` –ø–æ `(dbid, userid, queryid)` –∏ –¥–∞—ë—Ç –≥–æ—Ç–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è/—Å–∫–æ—Ä–∏–Ω–≥–∞.

---

## –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ—Ä—è–¥–æ–∫ –∑–∞–ø—É—Å–∫–∞ (pipeline)
–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ü–∏–∫–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É):
1) `collector.py`
2) `build_deltas.py`
3) `build_features.py`

–õ–µ–∫—Å–∏–∫—É –º–æ–∂–Ω–æ:
- –ª–∏–±–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –∫–∞–∂–¥—ã–π —Ü–∏–∫–ª (–ø—Ä–æ—â–µ)
- –ª–∏–±–æ —Ä–µ–∂–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä —Ä–∞–∑ –≤ 10‚Äì60 –º–∏–Ω—É—Ç):
4) `build_lex_features.py`

---

## –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç (—Ä—É—á–Ω–æ–π)
1) –≤—ã–ø–æ–ª–Ω–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ (—Å–æ–∑–¥–∞—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É)
2) –∑–∞–ø—É—Å—Ç–∏—Ç—å:
```bash
python3 collector.py
sleep 10
python3 collector.py
python3 build_deltas.py
python3 build_features.py
python3 build_lex_features.py
```
## ML System
–≠—Ç–∏ —Å–∫—Ä–∏–ø—Ç—ã —É–ø—Ä–∞–≤–ª—è—é—Ç –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –º–æ–¥–µ–ª–∏ (MLeC - Machine Learning Execution Cycle).


#### boot.py
- –ì–ª–∞–≤–Ω—ã–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ç–æ—Ä. –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞. <ul><li>–û–∂–∏–¥–∞–µ—Ç –ë–î, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è.</li><li>–í—ã–ø–æ–ª–Ω—è–µ—Ç –º–∏–≥—Ä–∞—Ü–∏—é (–ø—Ä–æ–≤–µ—Ä—è–µ—Ç/—Å–æ–∑–¥–∞–µ—Ç –Ω—É–∂–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü).</li><li>–ï—Å–ª–∏ –º–æ–¥–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ü–∏–∫–ª –ø–µ—Ä–≤–∏—á–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è (pgbench).</li><li>–ó–∞–ø—É—Å–∫–∞–µ—Ç main_loop (–ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Å–±–æ—Ä–∞/–¥–µ—Ç–µ–∫—Ü–∏–∏).</li></ul>
#### train_model.py
- –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ (Isolation Forest). <ul><li>–ë–µ—Ä–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ features_with_lex –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π (NOW() - INTERVAL '7 days').</li><li>–ö—Ä–∏—Ç–∏—á–Ω–æ: –§–∏–ª—å—Ç—Ä—É–µ—Ç –≤—Å–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (pg_catalog, monitoring, –∏ —Ç.–ø.) ‚Äî –º–æ–¥–µ–ª—å —É—á–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–µ.</li><li>–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ–±—É—á–µ–Ω–Ω—É—é –º–æ–¥–µ–ª—å –≤ model_baseline_v1.pkl.</li></ul>
#### detect_anomalies.py
- –î–µ—Ç–µ–∫—Ç–æ—Ä –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏. <ul><li>–ò—Å–ø–æ–ª—å–∑—É–µ—Ç Watermark (last_processed_ts –≤ drift_state.json) –¥–ª—è –≤—ã–±–æ—Ä–∫–∏ —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã—Ö, –Ω–µ–ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –æ–∫–æ–Ω.</li><li>–û—Ü–µ–Ω–∏–≤–∞–µ—Ç –∫–∞–∂–¥–æ–µ –æ–∫–Ω–æ, —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∞–Ω–æ–º–∞–ª–∏–∏.</li><li>–ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ anomaly_scores –¢–û–õ–¨–ö–û –∞–Ω–æ–º–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã.</li><li>–£–ø—Ä–∞–≤–ª—è–µ—Ç —Å—á–µ—Ç—á–∏–∫–æ–º –î—Ä–µ–π—Ñ–∞ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∞–ª–µ—Ä—Ç—ã.</li></ul>
#### drift_state.json
- –§–∞–π–ª —Å–æ—Å—Ç–æ—è–Ω–∏—è. –•—Ä–∞–Ω–∏—Ç bad_runs_streak (—Å—á–µ—Ç—á–∏–∫ –¥—Ä–µ–π—Ñ–∞) –∏ last_processed_ts (–∫—É—Ä—Å–æ—Ä –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è Watermark).

### –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫
**–ü–µ—Ä–≤–∏—á–Ω—ã–π –∑–∞–ø—É—Å–∫ (–£—Å—Ç–∞–Ω–æ–≤–∫–∞)**
1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env) –¥–ª—è Telegram –∏ –ë–î.
2. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –¥–ª—è —Å–±–æ—Ä–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∏ –µ–≥–æ –∑–∞–ø—É—Å–∫–∞:
```
docker compose up --build
```
3.–í–æ –≤—Ä–µ–º—è –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ boot.py:
- –°–æ–∑–¥–∞—Å—Ç —Ç–∞–±–ª–∏—Ü—ã, –æ—á–∏—Å—Ç–∏—Ç —Å—Ç–∞—Ä—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.
- –ó–∞–ø—É—Å—Ç–∏—Ç pgbench (–Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ) –Ω–∞ 180 —Å–µ–∫—É–Ω–¥.
- –°–æ–±–µ—Ä–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –∏ –æ–±—É—á–∏—Ç –ø–µ—Ä–≤—É—é –≤–µ—Ä—Å–∏—é –º–æ–¥–µ–ª–∏ (model_baseline_v1.pkl).
- –ü–µ—Ä–µ–π–¥–µ—Ç –≤ —Ä–µ–∂–∏–º –±–æ–µ–≤–æ–π –¥–µ—Ç–µ–∫—Ü–∏–∏.

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ—Ç–µ–∫—Ü–∏–∏ –∞–Ω–æ–º–∞–ª–∏–π**

–ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ —Å–∏—Å—Ç–µ–º–∞ –∑–∞–ø—É—â–µ–Ω–∞ –∏ –º–æ–¥–µ–ª—å –æ–±—É—á–µ–Ω–∞, –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –∫–∞–∫ –æ–Ω–∞ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ "–ø–ª–æ—Ö–æ–π" –∑–∞–ø—Ä–æ—Å.

1. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –ë–î.
2. –í—ã–ø–æ–ª–Ω–∏—Ç–µ —Ç—è–∂–µ–ª—ã–π, –Ω–µ—Ç–∏–ø–∏—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å. –ù–∞–ø—Ä–∏–º–µ—Ä, —Å 4-–º—è JOIN'–∞–º–∏ –∏–ª–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π:
```
SELECT pg_sleep(5);
```
3. –ü–æ–¥–æ–∂–¥–∏—Ç–µ 75 —Å–µ–∫—É–Ω–¥ (–∏–Ω—Ç–µ—Ä–≤–∞–ª —Ä–∞–±–æ—Ç—ã –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞).
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ anomaly_detector .
(```docker compose logs -f anomaly_detector```) –∏ —Å–≤–æ–π Telegram
–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
–õ–æ–≥–∏: ‚ö†Ô∏è –ê–Ω–æ–º–∞–ª–∏–∏! Streak: 1/5



**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –î—Ä–µ–π—Ñ–∞ (Drift)**
–ß—Ç–æ–±—ã –º–æ–¥–µ–ª—å –ø–µ—Ä–µ–æ–±—É—á–∏–ª–∞—Å—å, –Ω—É–∂–Ω–æ —Å–ø—Ä–æ–≤–æ—Ü–∏—Ä–æ–≤–∞—Ç—å 5 —Ü–∏–∫–ª–æ–≤ –ø–æ–¥—Ä—è–¥ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∞–Ω–æ–º–∞–ª–∏—è–º–∏ (5 * 75 —Å–µ–∫ = 6.25 –º–∏–Ω—É—Ç).
1. –í —Ç–µ—á–µ–Ω–∏–µ 6-7 –º–∏–Ω—É—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –≤—ã–ø–æ–ª–Ω—è–π—Ç–µ –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —Ç—è–∂–µ–ª—ã–π –∑–∞–ø—Ä–æ—Å (–∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑–Ω—ã—Ö —Ç—è–∂–µ–ª—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤).
2. –ù–∞ 5-–º —Ü–∏–∫–ª–µ –¥–µ—Ç–µ–∫—Ü–∏–∏ –≤ –ª–æ–≥–∞—Ö –ø–æ—è–≤–∏—Ç—Å—è:
``` üõë –î–†–ï–ô–§ –ü–û–î–¢–í–ï–†–ñ–î–ï–ù! (5 –∑–∞–ø—É—Å–∫–æ–≤ –ø–æ–¥—Ä—è–¥ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∞–Ω–æ–º–∞–ª–∏—è–º–∏) ```
3. –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å—Ç–∏—Ç train_model.py –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç –Ω–æ–≤—É—é –º–æ–¥–µ–ª—å.

**–í–∞–∂–Ω–æ**: –î–ª—è —Å–±—Ä–æ—Å–∞ —Å–∏—Å—Ç–µ–º—ã –∏ –Ω–∞—á–∞–ª–∞ –Ω–æ–≤–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–º–µ–Ω–∏—Ç—å –æ–±—É—á–∞—é—â—É—é –Ω–∞–≥—Ä—É–∑–∫—É), –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:
```
docker compose down
rm scripts/drift_state.json # –°–±—Ä–æ—Å –∫—É—Ä—Å–æ—Ä–∞ –∏ —Å—á–µ—Ç—á–∏–∫–∞
docker compose up --build
```